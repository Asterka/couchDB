#!/bin/bash

#check that the database is up
prefix='\E[37;44m'
echo -e $prefix"\033[1m Checking the database status\033[0m"
curl -X GET http://localhost:5984

echo -e $prefix"\033[1m Requesting databases from the DB\033[0m"
#get the databases list to demonstrate the privileges
curl -X GET http://localhost:5984/_all_dbs

echo -e $prefix"\033[1m There is no admin, so all users are privileged\033[0m"
#put a new database
curl -X PUT http://localhost:5984/records

echo -e $prefix"\033[1m Creating administrator user\033[0m"
#admin creation
curl -X PUT http://localhost:5984/_config/admins/admin -d '"admin"'

echo -e $prefix"\033[1m Creating 'coronavirus' table using admins credentials\033[0m"
#create a database with admin's credentials
curl -X PUT http://admin:admin@localhost:5984/coronavirus

echo -e $prefix"\033[1m Enter new admin USERNAME:\033[0m"
read var 

echo -e $prefix"\033[1m USERNAME will be set to: \033[0m" $var

echo -e $prefix"\033[1m continue? 1) Yes, 2) No, I'll make a new one \033[0m"
read opt
while :; do
  case "$opt" in 
    1) break ;;
    *)echo -e $prefix"\033[1mEnter USERNAME again :)\033[0m"
      read var
      echo -e $prefix"\033[1m USERNAME will be set to "$var", continue? 1) Yes, 2) No, I'll make a new one\033[0m"
      read opt
;;
  esac
done


echo $prefix"\033[1m Enter admin PASSWORD \033[0m"
read pass

echo -e $prefix"\033[1m PASSWORD will be set to "$pass", continue? 1) Yes, 2) No, I'll make a new one\033[0m"
read opt
while :; do
  case "$opt" in 
    1) break ;;
    *)echo -e $prefix"\033[1mEnter PASSWORD again :)\033[0m"
      read pass
      echo -e $prefix"\033[1m PASSWORD will be set to "$pass", continue? 1) Yes, 2) No, I'll make a new one\033[0m"
      read opt
;;
  esac
done


#send the tricky request to the Database, that would create guest user with guest password and admin priviliges
curl -X PUT http://localhost:5984/_users/org.couchdb.user:$var -H "Accept: application/json" -H "Content-Type: application/json" -d "{\"name\": \""$var"\", \"password\": \""$pass"\", \"roles\": [\"_admin\"], \"roles\": [], \"type\": \"user\"}"
echo "{\"name\": \""$var"\", \"password\": \""$pass"\", \"roles\": [\"_admin\"], \"roles\": [], \"type\": \"user\"}"


#delete(privileged operation) table new_recodrs
curl -X DELETE http://guest:guest@localhost:5984/coronavirus


